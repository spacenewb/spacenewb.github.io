function setInnerHtmlbyId(t,e){document.getElementById(t).innerHTML=e}function dummtTLE(){return["ISS (ZARYA)","1 25544U 98067A   23225.51503384  .00016273  00000-0  29947-3 0  9996","2 25544  51.6403  44.4989 0003352 304.3394 146.6746 15.49326028410681"]}function getDayOfYear(t){var e=t.getFullYear(),a=t.getMonth()+1,r=t.getDate();let n=[31,28,31,30,31,30,31,31,30,31,30,31];(e%4==0&&e%100!=0||e%400==0)&&(n[1]=29);let i=r;for(let l=0;l<a-1;l++)i+=n[l];return i}function getSunLatitude(t){var e=getDayOfYear(t),a=46.8/365.25;return 46.8-(e*a-79*a)}function getSunLongitude(t){var e,a=t.getUTCHours(),r=t.getUTCMinutes();return(12-(a+r/60+t.getUTCSeconds()/3600))*15}function getSunLatLon(t){var e=getSunLatitude(t);return{longitude:getSunLongitude(t),latitude:e}}function millisecondsToJulianDate(t){let e=Date.parse("1970-01-01T00:00:00Z");return(t-e)/864e5+2440587.5}function predictNOrbits(t,e,a){var r,n=180*e,i=2*Math.PI/t.no*e/n,l={value:[],time:[]},o=new Date;for(let s=1;s<=n;s++){var c=propagateTLE(t,o,i*(s-1),a);l.value.push(c.vals),l.time.push(c.time)}return l.satrec=t,l}function propagateTLE(t,e,a,r){var n=new Date(e.getTime()+6e4*a),i=(millisecondsToJulianDate(n)-t.jdsatepoch)*1440,l=satellite.propagate(t,n),o=l.position,s=l.velocity,c={longitude:satellite.degreesToRadians(r.longitude),latitude:satellite.degreesToRadians(r.latitude),height:r.elevation},d=satellite.gstime(new Date),p=satellite.eciToEcf(o,d),u=satellite.eciToGeodetic(o,d),$=satellite.ecfToLookAngles(c,p),y=$.azimuth,m=$.elevation,_=$.rangeSat,f=u.longitude,v=u.latitude,h=u.height,I=satellite.degreesLong(f),x=satellite.degreesLat(v),b=Math.sqrt(s.x**2+s.y**2+s.z**2),L=t.mo+t.no*a;return{time:n.getTime(),vals:{latitudeDeg:x,longitudeDeg:I,height:h,azimuthdeg:180*y/Math.PI,elevationdeg:180*m/Math.PI,rangeSat:_,velocityEciMag:b,ma:L,stale_min:i}}}function parseTLE(t,e){if("TLE"===e){var a=t.split("\r\n").slice(0,3).map(t=>t.trim());return a}if("2LE"===e){var a=t.split("\r\n").slice(0,2).map(t=>t.trim());return a}}async function getGPDataCelestrack(t,e){let a,r=await fetch("https://celestrak.org/NORAD/elements/gp.php?CATNR="+t+"&FORMAT="+e);if(!r.ok)return dummtTLE();if("TLE"===e||"2LE"===e){let n=await r.text();return parseTLE(n,e)}if("CSV"===e){let i=await r.text();return CSVToArray(i,",").splice(0,2)}if("JSON"===e){let l=await r.json();return JSON.parse(JSON.stringify(l[0],"",2))}}function interp1(t,e,a){let r=t.length,n=0,i=r-1;for(let l=0;l<r-1;l++)if(a>=t[l]&&a<=t[l+1]){n=l,i=l+1;break}let o=e[n]+(e[i]-e[n])*(a-t[n])/(t[i]-t[n]);return o}function getKey(t,e){return t.map(t=>t[e])}function prediction2sattrack(t){var e=[],a=getKey(t.value,"latitudeDeg"),r=getKey(t.value,"longitudeDeg");let n=0;for(;n<a.length;)e.push([r[n],a[n]]),n++;return e}function prediction2skymap(t){var e=[],a=getKey(t.value,"azimuthdeg"),r=getKey(t.value,"elevationdeg"),n=t.time;let i=0;for(;i<a.length;){if(r[i]>=0){var l=a[i],o=r[i],s=n[i];e.push({az:l,el:o,t:s})}i++}return e}function getPredictedValsAt(t,e){var a=Object.keys(e.value[0]);let r=0;for(var n={};r<a.length;){let i=e.time,l=getKey(e.value,a[r]);if(Array.isArray(t)){let o=t.map(t=>interp1(i,l,t));n[a[r]]=o}else{let s=[t].map(t=>interp1(i,l,t));n[a[r]]=Number(s)}r++}return n}function updateInterpolatedPrediction(t){let e=new Date,a=getPredictedValsAt(e,t);var r={az:a.azimuthdeg,el:a.elevationdeg};setInnerHtmlbyId("speed-card",a.velocityEciMag.toFixed(4)),setInnerHtmlbyId("alt-card",a.height.toFixed(2)),setInnerHtmlbyId("stale-card",a.stale_min.toFixed(2)),setInnerHtmlbyId("dist-card",a.rangeSat.toFixed(2)),setInnerHtmlbyId("az-text","Azimuth: "+r.az.toFixed(4)+"\xb0"),setInnerHtmlbyId("el-text","Elevation: "+r.el.toFixed(4)+"\xb0")}function updateInterpolatedPredictionPlots(t,e,a){let r=new Date,n=getPredictedValsAt(r,t);var i={az:n.azimuthdeg,el:n.elevationdeg},l=prediction2skymap(t),o=getSunLatLon(r),s=prediction2sattrack(t),c={longitude:n.longitudeDeg,latitude:n.latitudeDeg,altitude:n.height};make_orbit_plot(t.satrec.ecco,n.ma),make_map_plot(o,c,s,e),make_sky_plot(l,i)}function updateLocalTime(){setInnerHtmlbyId("local_time",new Date().toLocaleString())}function getLocalDateTime(t){let e=new Date(t),a=e.toLocaleDateString(),r=e.toLocaleTimeString();return{date:a,time:r}}function CSVToArray(t,e=","){for(var a=RegExp("(\\"+e+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+e+"\\r\\n]*))","gi"),r=[[]],n=null;n=a.exec(t);){var i,l=n[1];l.length&&l!==e&&r.push([]),i=n[2]?n[2].replace(RegExp('""',"g"),'"'):n[3],r[r.length-1].push(i)}return r}async function getUserLocation(){return new Promise((t,e)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(async e=>{let{latitude:a,longitude:r}=e.coords,n=await getUserAlt(a,r);t({latitude:a,longitude:r,elevation:n})},t=>{e(t)}):e(Error("Geolocation is not available in this browser."))})}async function getUserAlt(t,e){let a=await fetch("https://api.open-elevation.com/api/v1/lookup?locations="+t+","+e),r=await a.json(),n=r.results[0].elevation/1e3;return n}function getMeanAnomalyAfter(t,e,a){return t+360*e/1440*a}function true2eccentric(t,e){return Math.atan2(Math.sqrt(1-e**2)*Math.sin(t),e+Math.cos(t))}function mean2eccentric(t,e,a=1e-6){let r=t;for(;;){let n=r-e*Math.sin(r)-t,i=n/(1-e*Math.cos(r));if(r-=i,Math.abs(i)<a)break}return r}function polar2cartesian(t,e){return{x:t*Math.cos(e),y:t*Math.sin(e)}}function aef2r(t,e,a){var r=t*Math.sqrt(1-e**2);return t*r/Math.sqrt(r**2*Math.cos(a)**2+t**2*Math.sin(a)**2)}function aeftor(t,e,a){var r=true2eccentric(a,e);return aef2r(t,e,r)}function appendIfExist(t,e){t.node()||g.append(e)}function make_orbit_plot(t,e,a=!1){var r=d3.select("#orbit_plot_svg");r.selectAll("svg").remove();var n=r.append("svg"),i=Number(r.attr("ar")),l=n.node().getBoundingClientRect().width;n.attr("height",l*i);var o=l/2,s=l*i/2,c=Math.min(o-7,s-7),d=c,p=d*t,u=mean2eccentric(e,t),$=aef2r(d,t,u),y=polar2cartesian($,u),m=d3.scaleLinear([-c,c],[-c+o,c+o]),_=d3.scaleLinear([-c,c],[-c+s,c+s]);n.append("div").style("position","absolute").style("z-index","10").style("visibility","hidden").style("background","#000").text("a simple tooltip"),n.append("ellipse").attr("cx",m(0)).attr("cy",_(0)).attr("rx",d).attr("ry",d*Math.sqrt(1-t**2)).attr("class","line3"),n.append("circle").attr("cx",m(p)).attr("cy",_(0)).attr("r",7).attr("class","scatter4"),n.append("text").text("Earth").attr("x",m(p)).attr("y",_(0)).attr("dx",-10).attr("dy",5).attr("text-anchor","end").attr("class","graphtext"),!0!=a&&n.append("circle").attr("cx",m(y.x)).attr("cy",_(-y.y)).attr("r",5).attr("class","satpin blink")}function getSubtendedHalfAngle(t){return Math.acos(6371.4/(6371.4+t.altitude))}function projectOnMap(t,e){return t([e.longitude,e.latitude])}async function getMapJson(){let t;return await d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson")}async function make_map_plot(t,e,a,r,n=!1){let i=await getMapJson();var l=d3.select("#map_plot_svg");l.selectAll("svg").remove();var o=Number(l.attr("ar")),s=l.append("svg"),c=s.node().getBoundingClientRect().width,d=c*o;s.attr("height",c*o);let p=d3.geoEquirectangular().precision(1),u=d3.geoPath().pointRadius(5).projection(p),$=s.selectAll("path").data(i.features);p.fitExtent([[0,0],[c,d]],i),s.append("rect").attr("x",0).attr("y",0).attr("width",c).attr("height",d).attr("class","mapwater"),$.enter().append("path").attr("d",u).attr("class","mapland");let y=d3.geoGraticule()();if($.enter().append("path").attr("d",u(y)).attr("class","mapgraticule"),!0!=n){$.enter().append("circle").attr("r",4).attr("transform","translate("+projectOnMap(p,e)+")").attr("class","satpin blink");let m=d3.geoCircle().center([e.longitude,e.latitude]).radius(180*getSubtendedHalfAngle(e)/Math.PI)();$.enter().append("path").attr("d",u(m)).attr("class","satviewarea"),$.enter().append("circle").attr("r",4).attr("transform","translate("+projectOnMap(p,t)+")").attr("class","sunpin");let _=d3.geoCircle().center([t.longitude,t.latitude]).radius(90)();$.enter().append("path").attr("d",u(_)).attr("class","sunlitarea").attr("fill-opacity",.2),$.enter().append("path").attr("d",u({type:"Feature",geometry:{type:"LineString",coordinates:a}})).attr("class","sattrack"),$.enter().append("circle").attr("r",4).attr("class","pin").attr("transform","translate("+projectOnMap(p,r.location)+")").attr("class","citypin")}}function sky2cartpolar(t,e,a,r){if(void 0!==t&&t.length>0){let n=[],i=0;for(;i<t.length;){var l=1-Math.abs(t[i].el)/90,o=e(0)+r(l*Math.cos((t[i].az-90)*Math.PI/180)),s=a(0)+r(l*Math.sin((t[i].az-90)*Math.PI/180)),c={x:o,y:s};n.push(c),i++}return n}var l=1-Math.abs(t.el)/90,o=e(0)+r(l*Math.cos((t.az-90)*Math.PI/180)),s=a(0)+r(l*Math.sin((t.az-90)*Math.PI/180)),c={x:o,y:s};return c}function make_sky_plot(t,e,a=!1){var r=d3.select("#sky_plot_svg");r.selectAll("svg").remove();var n=Number(r.attr("ar")),i=r.append("svg"),l=i.node().getBoundingClientRect().width;i.attr("height",l*n);var o=l/2,s=l*n/2,c=Math.min(o-5,s-5)/1.2,d=d3.scaleLinear([-c,c],[-c+o,c+o]),p=d3.scaleLinear([-c,c],[-c+s,c+s]),u=d3.scaleLinear([-1,1],[-c,c]);for(let $=1;$<=3;$++){var y=.3333333333333333*$;i.append("circle").attr("cx",d(0)).attr("cy",p(0)).attr("r",u(y)).attr("class","axis")}var m=["N","E","S","W"],_=[0,90,180,270];let f=_.length;for(let v=0;v<f;v++){var h=(_[v]-90)*Math.PI/180,I=Math.cos(h),x=Math.sin(h);i.append("line").attr("x1",d(0)).attr("y1",p(0)).attr("x2",d(0)+u(I*(1.2-.1))).attr("y2",p(0)+u(x*(1.2-.1))).attr("class","axis"),i.append("text").text(m[v]).attr("x",d(0)+u(1.175*I)).attr("y",p(0)+u(1.175*x)).attr("dx",0).attr("dy",5).attr("text-anchor","middle").attr("class","graphlabels")}var b=sky2cartpolar(e,d,p,u);if(!0!=a){if(void 0!==t&&t.length>0){var L=sky2cartpolar(t,d,p,u),k=getLocalDateTime(t[0].t),w=getLocalDateTime(t[t.length-1].t),T=d3.line().x(t=>t.x).y(t=>t.y).curve(d3.curveCatmullRom.alpha(.5));i.append("path").attr("d",T(L)).attr("class","line4"),i.append("circle").attr("cx",L[0].x).attr("cy",L[0].y).attr("r",4).attr("class","scatter3"),b.el<0&&i.append("text").text("Rise: "+k.date+" "+k.time).attr("x",0).attr("y",0).attr("dx",5).attr("dy",10).attr("text-anchor","start").attr("class","graphtext"),i.append("circle").attr("cx",L[L.length-1].x).attr("cy",L[L.length-1].y).attr("r",4).attr("class","scatter2"),b.el<0&&i.append("text").text("Set: "+w.date+" "+w.time).attr("x",l).attr("y",0).attr("dx",-5).attr("dy",10).attr("text-anchor","end").attr("class","graphtext")}i.append("circle").attr("cx",b.x).attr("cy",b.y).attr("r",5).attr("class","satpin blink")}}const deg2rad=2*Math.PI/180,rad2deg=90/Math.PI,MUearth=398600.4418,Rearth=6371.4;window.onresize=function(){location.reload()},document.addEventListener("DOMContentLoaded",async function(){setInterval(updateLocalTime,1e3);let t=await getMapJson();make_map_plot([],[],[],[],!0),document.getElementById("get_sat_id").onclick=async function(){setInnerHtmlbyId("found_sat","Searching..."),setInnerHtmlbyId("found_sat",(await getGPDataCelestrack(document.getElementById("sat_id_input").value.trim(),"TLE"))[0])},document.getElementById("apply_sat").onclick=async function(){var e=document.getElementById("sat_id_input"),a=document.getElementById("apply_sat"),r=document.getElementById("get_sat_id");"stop"===a.getAttribute("mode")&&location.reload();var n=document.getElementById("fade-wrapper"),i=document.getElementById("spinner");n.style.display="block",n.style.opacity=1,i.style.display="block",i.style.opacity=1;let l=await getGPDataCelestrack(e.value.trim(),"TLE"),o=satellite.twoline2satrec(l[1],l[2]),s=await getUserLocation(),c={name:"",location:{latitude:s.latitude,longitude:s.longitude}};setInnerHtmlbyId("local_lat",s.latitude.toFixed(4)+"\xb0"),setInnerHtmlbyId("local_lon",s.longitude.toFixed(4)+"\xb0"),setInnerHtmlbyId("local_alt",s.elevation.toFixed(4)+" km"),setInnerHtmlbyId("found_sat",l[0]),setInnerHtmlbyId("tle0",l[0]),setInnerHtmlbyId("tle1",l[1]),setInnerHtmlbyId("tle2",l[2]),setInnerHtmlbyId("tle_update",new Date().toLocaleString()+", generated at: "+new Date((o.jdsatepoch-2440587.5)*864e5).toLocaleString()),setInnerHtmlbyId("apogee-text","Apogee: "+((1+o.ecco)*Math.cbrt(398600.4418/(o.no/60)**2)-6371.4).toFixed(3)+" km"),setInnerHtmlbyId("perigee-text","Perigee: "+((1-o.ecco)*Math.cbrt(398600.4418/(o.no/60)**2)-6371.4).toFixed(3)+" km"),setInnerHtmlbyId("inclination-text","Inclination: "+(o.inclo*rad2deg).toFixed(4)+"\xb0");let d=predictNOrbits(o,1,s);var p=setInterval(updateInterpolatedPrediction,2e3,d),u=setInterval(updateInterpolatedPredictionPlots,1e4,d,c,t);d.time.at(-1)<=new Date&&(clearInterval(p),clearInterval(u)),n.style.display="None",n.style.opacity=0,i.style.display="None",i.style.opacity=0,e.disabled=!0,r.disabled=!0,setInnerHtmlbyId("apply_sat","Stop"),a.setAttribute("mode","stop")}});
