function setInnerHtmlbyId(e,t){document.getElementById(e).innerHTML=t}function dummtTLE(){return["ISS (ZARYA)","1 25544U 98067A   23225.51503384  .00016273  00000-0  29947-3 0  9996","2 25544  51.6403  44.4989 0003352 304.3394 146.6746 15.49326028410681"]}function getDayOfYear(e){var t=e.getFullYear(),n=e.getMonth()+1,a=e.getDate();let i=[31,28,31,30,31,30,31,31,30,31,30,31];(t%4==0&&t%100!=0||t%400==0)&&(i[1]=29);let l=a;for(let r=0;r<n-1;r++)l+=i[r];return l}function getSunLatitude(e){var t=getDayOfYear(e),n=46.8/365.25;return 46.8-(t*n-79*n)}function getSunLongitude(e){var t,n=e.getUTCHours(),a=e.getUTCMinutes();return(12-(n+a/60+e.getUTCSeconds()/3600))*15}function getSunLatLon(e){var t=getSunLatitude(e);return{longitude:getSunLongitude(e),latitude:t}}function millisecondsToJulianDate(e){let t=Date.parse("1970-01-01T00:00:00Z");return(e-t)/864e5+2440587.5}function predictNOrbits(e,t,n){var a,i=360*t,l=2*Math.PI/e.no*t/i,r={value:[],time:[]},o=new Date;for(let d=1;d<=i;d++){var s=propagateTLE(e,o,l*(d-1),n);r.value.push(s.vals),r.time.push(s.time)}return r.satrec=e,r}function propagateTLE(e,t,n,a){var i=new Date(t.getTime()+6e4*n),l=(millisecondsToJulianDate(i)-e.jdsatepoch)*1440,r=satellite.propagate(e,i),o=r.position,d=r.velocity,s={longitude:satellite.degreesToRadians(a.longitude),latitude:satellite.degreesToRadians(a.latitude),height:a.elevation},u=satellite.gstime(new Date),c=satellite.eciToEcf(o,u),g=satellite.eciToGeodetic(o,u),$=satellite.ecfToLookAngles(s,c),m=$.azimuth,p=$.elevation,y=$.rangeSat,I=g.longitude,_=g.latitude,f=g.height,v=satellite.degreesLong(I),L=satellite.degreesLat(_),h=Math.sqrt(d.x**2+d.y**2+d.z**2),T=e.mo+e.no*n;return{time:i.getTime(),vals:{latitudeDeg:L,longitudeDeg:v,height:f,azimuthdeg:180*m/Math.PI,elevationdeg:180*p/Math.PI,rangeSat:y,velocityEciMag:h,ma:T,stale_min:l}}}function parseTLE(e,t){if("TLE"===t){var n=e.split("\r\n").slice(0,3).map(e=>e.trim());return n}if("2LE"===t){var n=e.split("\r\n").slice(0,2).map(e=>e.trim());return n}}async function getGPDataCelestrack(e,t){let n,a=await fetch("https://celestrak.org/NORAD/elements/gp.php?CATNR="+e+"&FORMAT="+t);if(console.log(a),!a.ok)return dummtTLE();if("TLE"===t||"2LE"===t){let i=await a.text();return parseTLE(i,t)}if("CSV"===t){let l=await a.text();return CSVToArray(l,",").splice(0,2)}if("JSON"===t){let r=await a.json();return JSON.parse(JSON.stringify(r[0],"",2))}}function interp1(e,t,n){let a=e.length,i=0,l=a-1;for(let r=0;r<a-1;r++)if(n>=e[r]&&n<=e[r+1]){i=r,l=r+1;break}let o=t[i]+(t[l]-t[i])*(n-e[i])/(e[l]-e[i]);return o}function getKey(e,t){return e.map(e=>e[t])}function prediction2sattrack(e){var t=[],n=getKey(e.value,"latitudeDeg"),a=getKey(e.value,"longitudeDeg");let i=0;for(;i<n.length;)t.push([a[i],n[i]]),i++;return t}function prediction2skymap(e){var t=[],n=getKey(e.value,"azimuthdeg"),a=getKey(e.value,"elevationdeg"),i=e.time;let l=0;for(;l<n.length;){if(a[l]>=0){var r=n[l],o=a[l],d=i[l];t.push({az:r,el:o,t:d})}l++}return t}function getPredictedValsAt(e,t){var n=Object.keys(t.value[0]);let a=0;for(var i={};a<n.length;){let l=t.time,r=getKey(t.value,n[a]);if(Array.isArray(e)){let o=e.map(e=>interp1(l,r,e));i[n[a]]=o}else{let d=[e].map(e=>interp1(l,r,e));i[n[a]]=Number(d)}a++}return i}function updateInterpolatedPrediction(e,t){let n=new Date,a=getPredictedValsAt(n,e);console.log(a);var i=getSunLatLon(n),l=prediction2sattrack(e),r={longitude:a.longitudeDeg,latitude:a.latitudeDeg,altitude:a.height},o=prediction2skymap(e),d={az:a.azimuthdeg,el:a.elevationdeg};setInnerHtmlbyId("speed-card",a.velocityEciMag.toFixed(4)),setInnerHtmlbyId("alt-card",a.height.toFixed(2)),setInnerHtmlbyId("stale-card",a.stale_min.toFixed(2)),setInnerHtmlbyId("dist-card",a.rangeSat.toFixed(2)),setInnerHtmlbyId("az-text","Azimuth: "+d.az.toFixed(4)+"\xb0"),setInnerHtmlbyId("el-text","Elevation: "+d.el.toFixed(4)+"\xb0"),console.log(i),console.log(r),console.log(l),console.log(t),make_orbit_plot(e.satrec.ecco,a.ma),make_map_plot(i,r,l,t),make_sky_plot(o,d)}function updateLocalTime(){setInnerHtmlbyId("local_time",new Date().toLocaleString())}function getLocalDateTime(e){let t=new Date(e),n=t.toLocaleDateString(),a=t.toLocaleTimeString();return{date:n,time:a}}const deg2rad=2*Math.PI/180,rad2deg=90/Math.PI,MUearth=398600.4418,Rearth=6371.4;function CSVToArray(e,t=","){for(var n=RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),a=[[]],i=null;i=n.exec(e);){var l,r=i[1];r.length&&r!==t&&a.push([]),l=i[2]?i[2].replace(RegExp('""',"g"),'"'):i[3],a[a.length-1].push(l)}return a}async function getUserLocation(){return new Promise((e,t)=>{"geolocation"in navigator?navigator.geolocation.getCurrentPosition(async t=>{let{latitude:n,longitude:a}=t.coords,i=await getUserAlt(n,a);e({latitude:n,longitude:a,elevation:i})},e=>{t(e)}):t(Error("Geolocation is not available in this browser."))})}async function getUserAlt(e,t){let n=await fetch("https://api.open-elevation.com/api/v1/lookup?locations="+e+","+t),a=await n.json(),i=a.results[0].elevation/1e3;return i}function getMeanAnomalyAfter(e,t,n){return e+360*t/1440*n}document.addEventListener("DOMContentLoaded",async function(){setInterval(updateLocalTime,1e3),document.getElementById("get_sat_id").onclick=async function(){setInnerHtmlbyId("found_sat","Searching..."),setInnerHtmlbyId("found_sat",(await getGPDataCelestrack(document.getElementById("sat_id_input").value.trim(),"TLE"))[0])},document.getElementById("apply_sat").onclick=async function(){var e=document.getElementById("fade-wrapper"),t=document.getElementById("spinner");e.style.display="block",e.style.opacity=1,t.style.display="block",t.style.opacity=1;var n=document.getElementById("sat_id_input");let a=await getGPDataCelestrack(n.value.trim(),"TLE"),i=satellite.twoline2satrec(a[1],a[2]),l=await getUserLocation(),r={name:"",location:{latitude:l.latitude,longitude:l.longitude}};setInnerHtmlbyId("local_lat",l.latitude.toFixed(4)+"\xb0"),setInnerHtmlbyId("local_lon",l.longitude.toFixed(4)+"\xb0"),setInnerHtmlbyId("local_alt",l.elevation.toFixed(4)+" km"),console.log(l),setInnerHtmlbyId("found_sat",a[0]),setInnerHtmlbyId("tle0",a[0]),setInnerHtmlbyId("tle1",a[1]),setInnerHtmlbyId("tle2",a[2]),setInnerHtmlbyId("tle_update",new Date().toLocaleString()+", generated at: "+new Date((i.jdsatepoch-2440587.5)*864e5).toLocaleString()),setInnerHtmlbyId("apogee-text","Apogee: "+((1+i.ecco)*Math.cbrt(398600.4418/(i.no/60)**2)-6371.4).toFixed(3)+" km"),setInnerHtmlbyId("perigee-text","Perigee: "+((1-i.ecco)*Math.cbrt(398600.4418/(i.no/60)**2)-6371.4).toFixed(3)+" km"),setInnerHtmlbyId("inclination-text","Inclination: "+(i.inclo*rad2deg).toFixed(4)+"\xb0"),console.log(a);let o=predictNOrbits(i,1,l);console.log(o);var d=setInterval(updateInterpolatedPrediction,2e3,o,r);o.time.at(-1)<=new Date&&clearInterval(d),e.style.display="None",e.style.opacity=0,t.style.display="None",t.style.opacity=0}});
